{
  "rules": {
    ".read": false,
    ".write": false,
    
    "messages": {
      "$roomId": {
        ".read": "auth !== null && root.child('roomMembers').child($roomId).child(auth.uid).exists()",
        ".write": "auth !== null && root.child('roomMembers').child($roomId).child(auth.uid).exists()",
        "$messageId": {
          ".validate": "newData.hasChildren(['text', 'userId', 'timestamp'])",
          "text": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 2000"
          },
          "userId": {
            ".validate": "newData.isString() && newData.val() === auth.uid"
          },
          "timestamp": {
            ".validate": "newData.isNumber() && newData.val() <= now"
          },
          "mediaUrl": {
            ".validate": "!newData.exists() || newData.isString()"
          },
          "mediaType": {
            ".validate": "!newData.exists() || newData.isString()"
          }
        }
      }
    },
    
    "roomMembers": {
      "$roomId": {
        ".read": "auth !== null",
        ".write": "auth !== null && ((data.exists() && data.child(auth.uid).exists()) || (root.child('events').child($roomId).exists() && root.child('attendees').child($roomId).child(auth.uid).exists()))",
        "$userId": {
          ".validate": "newData.isBoolean() && $userId === auth.uid"
        }
      }
    },
    
    "userRooms": {
      "$userId": {
        ".read": "auth !== null && auth.uid === $userId",
        ".write": "auth !== null && auth.uid === $userId",
        "$roomId": {
          ".validate": "newData.isBoolean() && root.child('roomMembers').child($roomId).child($userId).exists()"
        }
      }
    },
    
    "directMessages": {
      "$chatId": {
        ".read": "auth !== null && (auth.uid === $chatId.split('_')[0] || auth.uid === $chatId.split('_')[1])",
        ".write": "auth !== null && (auth.uid === $chatId.split('_')[0] || auth.uid === $chatId.split('_')[1])",
        "$messageId": {
          ".validate": "newData.hasChildren(['text', 'userId', 'timestamp'])",
          "text": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 2000"
          },
          "userId": {
            ".validate": "newData.isString() && newData.val() === auth.uid"
          },
          "timestamp": {
            ".validate": "newData.isNumber() && newData.val() <= now"
          },
          "mediaUrl": {
            ".validate": "!newData.exists() || newData.isString()"
          },
          "mediaType": {
            ".validate": "!newData.exists() || newData.isString()"
          }
        }
      }
    },
    
    "userConversations": {
      "$userId": {
        ".read": "auth !== null && auth.uid === $userId",
        ".write": "auth !== null && auth.uid === $userId",
        "$chatId": {
          ".validate": "newData.hasChildren(['lastMessage', 'lastTimestamp', 'otherUserId'])",
          "unreadCount": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          }
        }
      }
    },
    
    "messageStatus": {
      "$messageId": {
        ".read": "auth !== null && root.child('messages').child($messageId).child('userId').val() === auth.uid",
        "$userId": {
          ".write": "auth !== null && auth.uid === $userId",
          "read": {
            ".validate": "newData.isBoolean()"
          }
        }
      }
    },
    
    "typing": {
      "$roomId": {
        ".read": "auth !== null && root.child('roomMembers').child($roomId).child(auth.uid).exists()",
        "$userId": {
          ".write": "auth !== null && auth.uid === $userId",
          ".validate": "newData.isBoolean() || newData.isNumber()"
        }
      }
    }
  }
}